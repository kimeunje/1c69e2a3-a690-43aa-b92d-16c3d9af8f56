import enum
from datetime import datetime, date
from typing import Optional
from sqlalchemy import String, Text, Enum, DateTime, Date, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.core.database import Base
from app.models.base import TimestampMixin


# ========================================
# 점검 (상위 계층)
# ========================================
class AssessmentStatus(str, enum.Enum):
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"


class Assessment(Base, TimestampMixin):
    __tablename__ = "assessments"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(500), nullable=False)
    assessor: Mapped[Optional[str]] = mapped_column(String(200), nullable=True)  # 점검기관
    assessed_at: Mapped[Optional[date]] = mapped_column(Date, nullable=True)  # 점검일
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    status: Mapped[AssessmentStatus] = mapped_column(
        Enum(AssessmentStatus, name="assessment_status"),
        default=AssessmentStatus.IN_PROGRESS,
        nullable=False,
    )

    # Relationships
    vulnerabilities = relationship("Vulnerability", back_populates="assessment", cascade="all, delete-orphan")

    def __repr__(self) -> str:
        return f"<Assessment(id={self.id}, name='{self.name}')>"


# ========================================
# 취약점
# ========================================
class VulnStatus(str, enum.Enum):
    UNASSIGNED = "unassigned"              # 미배정
    PENDING_SCHEDULE = "pending_schedule"   # 일정대기 (담당자 지정됨, 일정 미입력)
    PENDING_APPROVAL = "pending_approval"   # 결재대기 (일정 입력됨, 결재 대기중)
    IN_PROGRESS = "in_progress"            # 조치중 (결재 승인됨)
    DONE = "done"                          # 완료


class Vulnerability(Base, TimestampMixin):
    __tablename__ = "vulnerabilities"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    assessment_id: Mapped[int] = mapped_column(ForeignKey("assessments.id"), nullable=False)

    # 취약점 정보
    category: Mapped[Optional[str]] = mapped_column(String(200), nullable=True)   # 점검 분류
    asset: Mapped[Optional[str]] = mapped_column(String(300), nullable=True)      # 자산 구분
    item: Mapped[str] = mapped_column(String(500), nullable=False)                # 취약 항목
    content: Mapped[Optional[str]] = mapped_column(Text, nullable=True)           # 취약 내용
    issue: Mapped[Optional[str]] = mapped_column(Text, nullable=True)             # 현황 및 문제점

    # 담당 및 일정
    assignee_id: Mapped[Optional[int]] = mapped_column(ForeignKey("users.id"), nullable=True)
    approver_id: Mapped[Optional[int]] = mapped_column(ForeignKey("users.id"), nullable=True)
    due_date: Mapped[Optional[date]] = mapped_column(Date, nullable=True)

    # 상태 및 조치
    status: Mapped[VulnStatus] = mapped_column(
        Enum(VulnStatus, name="vuln_status"),
        default=VulnStatus.UNASSIGNED,
        nullable=False,
        index=True,
    )
    action_plan: Mapped[Optional[str]] = mapped_column(Text, nullable=True)    # 조치 계획
    action_result: Mapped[Optional[str]] = mapped_column(Text, nullable=True)  # 조치 결과
    note: Mapped[Optional[str]] = mapped_column(Text, nullable=True)           # 비고

    # Relationships
    assessment = relationship("Assessment", back_populates="vulnerabilities")
    assignee = relationship("User", foreign_keys=[assignee_id], back_populates="assigned_vulnerabilities")
    approver = relationship("User", foreign_keys=[approver_id], back_populates="approval_vulnerabilities")
    action_logs = relationship("VulnActionLog", back_populates="vulnerability", cascade="all, delete-orphan")
    approval_requests = relationship("ApprovalRequest", back_populates="vulnerability", cascade="all, delete-orphan")

    def __repr__(self) -> str:
        return f"<Vulnerability(id={self.id}, item='{self.item}', status='{self.status}')>"


# ========================================
# 조치 이력
# ========================================
class ActionType(str, enum.Enum):
    ASSIGNED = "assigned"
    SCHEDULED = "scheduled"
    APPROVED = "approved"
    REJECTED = "rejected"
    STARTED = "started"
    COMPLETED = "completed"


class VulnActionLog(Base, TimestampMixin):
    __tablename__ = "vuln_action_logs"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    vulnerability_id: Mapped[int] = mapped_column(ForeignKey("vulnerabilities.id"), nullable=False)
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"), nullable=False)
    action_type: Mapped[ActionType] = mapped_column(
        Enum(ActionType, name="action_type"),
        nullable=False,
    )
    comment: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    attachment_path: Mapped[Optional[str]] = mapped_column(String(1000), nullable=True)

    # Relationships
    vulnerability = relationship("Vulnerability", back_populates="action_logs")
    user = relationship("User")

    def __repr__(self) -> str:
        return f"<VulnActionLog(id={self.id}, type='{self.action_type}')>"


# ========================================
# 결재 요청
# ========================================
class ApprovalStatus(str, enum.Enum):
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED = "rejected"


class ApprovalRequest(Base, TimestampMixin):
    __tablename__ = "approval_requests"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    vulnerability_id: Mapped[int] = mapped_column(ForeignKey("vulnerabilities.id"), nullable=False)
    requester_id: Mapped[int] = mapped_column(ForeignKey("users.id"), nullable=False)
    approver_id: Mapped[int] = mapped_column(ForeignKey("users.id"), nullable=False)

    due_date: Mapped[Optional[date]] = mapped_column(Date, nullable=True)
    action_plan: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    status: Mapped[ApprovalStatus] = mapped_column(
        Enum(ApprovalStatus, name="approval_status"),
        default=ApprovalStatus.PENDING,
        nullable=False,
    )
    approved_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)
    reject_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    # Relationships
    vulnerability = relationship("Vulnerability", back_populates="approval_requests")
    requester = relationship("User", foreign_keys=[requester_id])
    approver = relationship("User", foreign_keys=[approver_id])

    def __repr__(self) -> str:
        return f"<ApprovalRequest(id={self.id}, status='{self.status}')>"
