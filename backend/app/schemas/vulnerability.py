from datetime import datetime, date
from typing import Optional
from pydantic import BaseModel
from app.models.vulnerability import AssessmentStatus, VulnStatus, ActionType, ApprovalStatus
from app.schemas.user import UserBrief


# ========================================
# Assessment
# ========================================
class AssessmentBase(BaseModel):
    name: str
    assessor: Optional[str] = None
    assessed_at: Optional[date] = None
    description: Optional[str] = None


class AssessmentCreate(AssessmentBase):
    pass


class AssessmentUpdate(BaseModel):
    name: Optional[str] = None
    assessor: Optional[str] = None
    assessed_at: Optional[date] = None
    description: Optional[str] = None
    status: Optional[AssessmentStatus] = None


class AssessmentResponse(AssessmentBase):
    id: int
    status: AssessmentStatus
    created_at: datetime
    # 동적 집계
    total_count: Optional[int] = None
    done_count: Optional[int] = None
    in_progress_count: Optional[int] = None
    pending_count: Optional[int] = None
    progress_percent: Optional[float] = None

    model_config = {"from_attributes": True}


# ========================================
# Vulnerability
# ========================================
class VulnerabilityBase(BaseModel):
    category: Optional[str] = None
    asset: Optional[str] = None
    item: str
    content: Optional[str] = None
    issue: Optional[str] = None
    note: Optional[str] = None


class VulnerabilityCreate(VulnerabilityBase):
    assessment_id: int


class VulnerabilityUpdate(BaseModel):
    category: Optional[str] = None
    asset: Optional[str] = None
    item: Optional[str] = None
    content: Optional[str] = None
    issue: Optional[str] = None
    note: Optional[str] = None


class VulnerabilityAssign(BaseModel):
    """담당자 지정"""
    assignee_id: int


class VulnerabilitySchedule(BaseModel):
    """일정 등록 & 결재 요청"""
    due_date: date
    approver_id: int
    action_plan: Optional[str] = None


class VulnerabilityActionResult(BaseModel):
    """조치 결과 제출"""
    status: VulnStatus  # done, in_progress
    action_result: str
    attachment_path: Optional[str] = None


class VulnerabilityResponse(VulnerabilityBase):
    id: int
    assessment_id: int
    assignee_id: Optional[int] = None
    approver_id: Optional[int] = None
    due_date: Optional[date] = None
    status: VulnStatus
    action_plan: Optional[str] = None
    action_result: Optional[str] = None
    created_at: datetime
    # Expanded
    assignee: Optional[UserBrief] = None
    approver: Optional[UserBrief] = None

    model_config = {"from_attributes": True}


class VulnerabilityListResponse(BaseModel):
    items: list[VulnerabilityResponse]
    total: int


# ========================================
# Action Log
# ========================================
class VulnActionLogResponse(BaseModel):
    id: int
    vulnerability_id: int
    user_id: int
    action_type: ActionType
    comment: Optional[str] = None
    attachment_path: Optional[str] = None
    created_at: datetime
    user: Optional[UserBrief] = None

    model_config = {"from_attributes": True}


# ========================================
# Approval Request
# ========================================
class ApprovalRequestResponse(BaseModel):
    id: int
    vulnerability_id: int
    requester_id: int
    approver_id: int
    due_date: Optional[date] = None
    action_plan: Optional[str] = None
    status: ApprovalStatus
    approved_at: Optional[datetime] = None
    reject_reason: Optional[str] = None
    created_at: datetime
    requester: Optional[UserBrief] = None
    approver: Optional[UserBrief] = None

    model_config = {"from_attributes": True}


class ApprovalAction(BaseModel):
    """결재 승인/반려"""
    action: ApprovalStatus  # approved or rejected
    reject_reason: Optional[str] = None
